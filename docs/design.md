# 포워더 마이크로서비스 설계

## 1. 개요
- 목적: 외부 시스템에서 HTTP POST(JSON)로 들어오는 명령을 기존 A 시스템에 전달해 기존 클라이언트들이 기대하는 응답(데이터 또는 지침)을 그대로 받을 수 있게 한다.
- 배포: Kubernetes 환경에서 단일 포워더 마이크로서비스(Pod)로 운영하며 표준 Pod 로그로 관측한다.
- 범위: API 규격, 책임, 에러/장애 처리 전략을 정의하고 미정 사항은 별도 TODO로 남긴다.

## 2. 시스템 컨텍스트
- 외부 호출자 → (HTTP POST) → **포워더 서비스** → (HTTP POST 변환) → **A 시스템**
- A 시스템은 POST로 받은 데이터를 내부 서비스에 전달하고, 요청자에게 결과 데이터나 다음 액션 지침을 반환한다.
- A 시스템 접속 전, 포워더는 `http://12.93.14.33:50009/EARS/Service/Multi?index=<계산값>`로 **HTTP GET**을 수행해 목적지 URL/Port를 획득한다.
  - `index` 값은 포워더가 요청마다 계산하는 값이며 계산 로직은 기존 시스템에서 제공받는다.
  - 현재 인증은 필요 없다고 파악되었다.
- 위치별 URL/Port가 다를 수 있으므로, 추후 설정 파일 혹은 ConfigMap으로 주입한다.

## 3. API 설계
### 3.1 외부 → 포워더
- `POST /forward` (초안, 경로는 조정 가능)
- 헤더
  - `Content-Type: application/json`
  - 선택: `X-Request-Id` 등 추적용 헤더는 수용 가능 (미정)
- 바디(JSON)
  ```json
  {
    "eqpId": "EQP-12345",
    "scenario": "heat-treatment-v1"
  }
  ```
  - 필드 정의는 담당자 협의 예정이며 현재는 대상 EQPID와 실행 시나리오명을 최소 요구사항으로 가정.
- 인증: 미정 (필요 시 mTLS, OAuth, API Key 등 선택)
- 응답: A 시스템 응답을 그대로 전달하는 것이 목표.
  - 성공(HTTP 2xx): A 시스템이 반환한 JSON/텍스트를 그대로 반환.
  - 실패: 아래 5절 참조.

### 3.2 포워더 → A 시스템
- 포워더는 2단계 호출을 수행:
  1. `GET http://12.93.14.33:50009/EARS/Service/Multi?index=<calc>` → 목적지 URL/Port 정보 획득.
  2. 획득한 URL/Port로 JSON POST를 수행.
- 헤더/바디 변환: **조정이 필요**하며 구체 로직은 추후 제공 예정.
  - 예: 필드명 매핑, 추가 메타데이터 삽입 등.
- 인증: 현재 없음. 추후 A 시스템이 인증을 요구하면 토큰/헤더 삽입 로직 추가.

## 4. 서비스 책임
1. 외부 POST 요청을 수신하고 최소 형식 검증(필수 필드, JSON 형태)을 수행한다.
2. index 계산 로직을 적용해 A 시스템 접속 정보를 조회한다.
3. A 시스템 요구 형식에 맞춰 헤더와 바디를 변환한다. (TBD)
4. A 시스템으로 요청을 전달하고 응답을 받아 호출자에게 반환한다.
5. Pod 로그에 요청 ID, 대상 EQPID, 시나리오, 응답 코드/지연시간 등을 남긴다.
6. 타임아웃, 예외를 감지해 적절한 HTTP 오류로 변환한다.

## 5. 오류 및 예외 처리
| 구분 | 상황 | 포워더 대응 | 외부 응답 |
| --- | --- | --- | --- |
| 입력 검증 실패 | 필수 필드 누락, JSON 파싱 오류 | 400 로그 기록 | `400 Bad Request` + 문제 설명 |
| 목적지 조회 실패 | GET `/EARS/Service/Multi` 실패/타임아웃 | 재시도 없음, 오류 로깅 | `502 Bad Gateway` (A 정보 조회 실패) |
| 변환 로직 실패 | 필드 매핑/필수 값 미생성 | 오류 로그 | `500 Internal Server Error` |
| A 시스템 타임아웃 | POST가 30초 초과 | 요청 취소, 오류 로그 | `504 Gateway Timeout` |
| A 시스템 4xx/5xx | 그대로 전달 | 필요 시 메시지 래핑 | `5xx/4xx` (가능하면 그대로) |
| 예기치 않은 예외 | 코드 버그, 런타임 에러 | Fail-fast, 알림 | `500 Internal Server Error` |

> 오류 응답 포맷(예: `{ "code": "...", "message": "..." }`)과 장애 시 알림/폴백 전략은 **미정**이며 6번 요구사항 논의 후 확정.

## 6. 비기능 요구사항
- **타임아웃:** 외부→A 홉 전체 30초 내. GET/POST 각각 10초/20초 등 세부 분할은 추후 조정.
- **재시도:** 수행하지 않음. A 시스템 특성상 중복 실행 위험이 있으므로 호출자는 재요청을 선택.
- **로깅:** Kubernetes Pod 로그에 구조화된 JSON 혹은 key=value 형태로 기록해 플랫폼 로거가 수집.
- **모니터링:** 기본 메트릭(요청 수, 성공률, 지연) 노출 필요. 방안은 추후(예: Prometheus metrics endpoint).
- **구성:** 목적지 조회 URL, index 계산 파라미터, 타임아웃 값 등을 ConfigMap/비밀로 외부화.

## 7. 오픈 이슈 / TODO
1. 외부 요청 인증 방식 결정 (없음/Token/mTLS 등).
2. 외부→포워더 API 경로 및 스키마 확정, 예시 JSON 제공.
3. 포워더→A 시스템 바디/헤더 변환 상세 로직.
4. 장애 시 알람 경로(Slack, PagerDuty 등)와 폴백 필요 여부.
5. 오류 응답 포맷 표준 정의.
6. 목적지 조회 GET 응답의 구조 및 캐싱 전략(매 요청 vs TTL).
